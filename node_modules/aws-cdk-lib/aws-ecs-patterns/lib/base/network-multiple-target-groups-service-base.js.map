{
  "version": 3,
  "sources": ["network-multiple-target-groups-service-base.ts"],
  "sourcesContent": ["import { IVpc } from '../../../aws-ec2';\nimport {\n  AwsLogDriver, BaseService, CloudMapOptions, Cluster, ContainerDefinition, ContainerImage, ICluster, LogDriver,\n  PropagatedTagSource, Protocol, Secret,\n} from '../../../aws-ecs';\nimport { NetworkListener, NetworkLoadBalancer, NetworkTargetGroup } from '../../../aws-elasticloadbalancingv2';\nimport { IRole } from '../../../aws-iam';\nimport { ARecord, IHostedZone, RecordTarget } from '../../../aws-route53';\nimport { LoadBalancerTarget } from '../../../aws-route53-targets';\nimport { CfnOutput, Duration, Stack } from '../../../core';\nimport { Construct } from 'constructs';\n\n                                                                                                                                  \nexport interface NetworkMultipleTargetGroupsServiceBaseProps {\n                                                                                                                                                                                                                                                                                                          \n  readonly cluster?: ICluster;\n\n                                                                                                                                                                                                                                                                                                                                        \n  readonly vpc?: IVpc;\n\n                                                                                                                                                                     \n  readonly taskImageOptions?: NetworkLoadBalancedTaskImageProps;\n\n                                                                                                                                                                                                                                                                                                                                                                                        \n  readonly desiredCount?: number;\n\n                                                                                         \n  readonly serviceName?: string;\n\n                                                                                                                                                                                                                                                                                                       \n  readonly healthCheckGracePeriod?: Duration;\n\n                                                                                                                                                            \n  readonly loadBalancers?: NetworkLoadBalancerProps[];\n\n                                                                                                                                                                                                                                                 \n  readonly propagateTags?: PropagatedTagSource;\n\n                                                                                                                                                                                                                                                                                   \n  readonly enableECSManagedTags?: boolean;\n\n                                                                                                                                                                 \n  readonly cloudMapOptions?: CloudMapOptions;\n\n                                                                                                                                                                        \n  readonly targetGroups?: NetworkTargetProps[];\n}\n\n                                                   \nexport interface NetworkLoadBalancedTaskImageProps {\n                                                                                                                                        \n  readonly image: ContainerImage;\n\n                                                                                                                   \n  readonly environment?: { [key: string]: string };\n\n                                                                                                                                         \n  readonly secrets?: { [key: string]: Secret };\n\n                                                                                    \n  readonly enableLogging?: boolean;\n\n                                                                                                  \n  readonly logDriver?: LogDriver;\n\n                                                                                                                                                                             \n  readonly executionRole?: IRole;\n\n                                                                                                                                                                                                \n  readonly taskRole?: IRole;\n\n                                                                                                           \n  readonly containerName?: string;\n\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           \n  readonly containerPorts?: number[];\n\n                                                                                                                                                                                            \n  readonly family?: string;\n\n                                                                                                   \n  readonly dockerLabels?: { [key: string]: string };\n}\n\n                                                         \nexport interface NetworkLoadBalancerProps {\n                                           \n  readonly name: string;\n\n                                                                                                            \n  readonly listeners: NetworkListenerProps[];\n\n                                                                                                      \n  readonly publicLoadBalancer?: boolean;\n\n                                                                                                              \n  readonly domainName?: string;\n\n                                                                                                                                \n  readonly domainZone?: IHostedZone;\n}\n\n                                                    \nexport interface NetworkListenerProps {\n                                      \n  readonly name: string;\n\n                                                                                           \n  readonly port?: number;\n}\n\n                                                                     \nexport interface NetworkTargetProps {\n                                                                                                                 \n  readonly containerPort: number;\n\n                                                                                                                                \n  readonly listener?: string;\n}\n\n                                                                                                                          \nexport abstract class NetworkMultipleTargetGroupsServiceBase extends Construct {\n                                                                                                                                                                   \n  public readonly desiredCount: number;\n\n                                                                                                                                                                                                                                                                    \n  public readonly internalDesiredCount?: number;\n\n                                                           \n  public readonly loadBalancer: NetworkLoadBalancer;\n\n                                              \n  public readonly listener: NetworkListener;\n\n                                                    \n  public readonly cluster: ICluster;\n\n  protected logDriver?: LogDriver;\n  protected listeners = new Array<NetworkListener>();\n  protected targetGroups = new Array<NetworkTargetGroup>();\n\n  private loadBalancers = new Array<NetworkLoadBalancer>();\n\n                                                                                               \n  constructor(scope: Construct, id: string, props: NetworkMultipleTargetGroupsServiceBaseProps = {}) {\n    super(scope, id);\n\n    this.validateInput(props);\n\n    this.cluster = props.cluster || this.getDefaultCluster(this, props.vpc);\n\n    this.desiredCount = props.desiredCount || 1;\n    this.internalDesiredCount = props.desiredCount;\n\n    if (props.taskImageOptions) {\n      this.logDriver = this.createLogDriver(props.taskImageOptions.enableLogging, props.taskImageOptions.logDriver);\n    }\n\n    if (props.loadBalancers) {\n      for (const lbProps of props.loadBalancers) {\n        const lb = this.createLoadBalancer(lbProps.name, lbProps.publicLoadBalancer);\n        this.loadBalancers.push(lb);\n        for (const listenerProps of lbProps.listeners) {\n          const listener = this.createListener(listenerProps.name, lb, listenerProps.port || 80);\n          this.listeners.push(listener);\n        }\n        this.createDomainName(lb, lbProps.domainName, lbProps.domainZone);\n        new CfnOutput(this, `LoadBalancerDNS${lb.node.id}`, { value: lb.loadBalancerDnsName });\n      }\n      // set up default load balancer and listener.\n      this.loadBalancer = this.loadBalancers[0];\n      this.listener = this.listeners[0];\n    } else {\n      this.loadBalancer = this.createLoadBalancer('LB');\n      this.listener = this.createListener('PublicListener', this.loadBalancer, 80);\n      this.createDomainName(this.loadBalancer);\n\n      new CfnOutput(this, 'LoadBalancerDNS', { value: this.loadBalancer.loadBalancerDnsName });\n    }\n  }\n\n                                             \n  protected getDefaultCluster(scope: Construct, vpc?: IVpc): Cluster {\n    // magic string to avoid collision with user-defined constructs.\n    const DEFAULT_CLUSTER_ID = `EcsDefaultClusterMnL3mNNYN${vpc ? vpc.node.id : ''}`;\n    const stack = Stack.of(scope);\n    return stack.node.tryFindChild(DEFAULT_CLUSTER_ID) as Cluster || new Cluster(stack, DEFAULT_CLUSTER_ID, { vpc });\n  }\n\n  protected createAWSLogDriver(prefix: string): AwsLogDriver {\n    return new AwsLogDriver({ streamPrefix: prefix });\n  }\n\n  protected findListener(name?: string): NetworkListener {\n    if (!name) {\n      return this.listener;\n    }\n    for (const listener of this.listeners) {\n      if (listener.node.id === name) {\n        return listener;\n      }\n    }\n    throw new Error(`Listener ${name} is not defined. Did you define listener with name ${name}?`);\n  }\n\n  protected registerECSTargets(service: BaseService, container: ContainerDefinition, targets: NetworkTargetProps[]): NetworkTargetGroup {\n    for (const targetProps of targets) {\n      const targetGroup = this.findListener(targetProps.listener).addTargets(`ECSTargetGroup${container.containerName}${targetProps.containerPort}`, {\n        port: 80,\n        targets: [\n          service.loadBalancerTarget({\n            containerName: container.containerName,\n            containerPort: targetProps.containerPort,\n          }),\n        ],\n      });\n      this.targetGroups.push(targetGroup);\n    }\n    if (this.targetGroups.length === 0) {\n      throw new Error('At least one target group should be specified.');\n    }\n    return this.targetGroups[0];\n  }\n\n  protected addPortMappingForTargets(container: ContainerDefinition, targets: NetworkTargetProps[]) {\n    for (const target of targets) {\n      if (!container.findPortMapping(target.containerPort, Protocol.TCP)) {\n        container.addPortMappings({\n          containerPort: target.containerPort,\n        });\n      }\n    }\n  }\n\n  /**\n   * Create log driver if logging is enabled.\n   */\n  private createLogDriver(enableLoggingProp?: boolean, logDriverProp?: LogDriver): LogDriver | undefined {\n    const enableLogging = enableLoggingProp ?? true;\n    const logDriver = logDriverProp ?? (enableLogging ? this.createAWSLogDriver(this.node.id) : undefined);\n    return logDriver;\n  }\n\n  private validateInput(props: NetworkMultipleTargetGroupsServiceBaseProps) {\n    if (props.cluster && props.vpc) {\n      throw new Error('You can only specify either vpc or cluster. Alternatively, you can leave both blank');\n    }\n\n    if (props.desiredCount !== undefined && props.desiredCount < 1) {\n      throw new Error('You must specify a desiredCount greater than 0');\n    }\n\n    if (props.loadBalancers) {\n      if (props.loadBalancers.length === 0) {\n        throw new Error('At least one load balancer must be specified');\n      }\n      for (const lbProps of props.loadBalancers) {\n        if (lbProps.listeners.length === 0) {\n          throw new Error('At least one listener must be specified');\n        }\n      }\n    }\n  }\n\n  private createLoadBalancer(name: string, publicLoadBalancer?: boolean): NetworkLoadBalancer {\n    const internetFacing = publicLoadBalancer ?? true;\n    const lbProps = {\n      vpc: this.cluster.vpc,\n      internetFacing,\n    };\n\n    return new NetworkLoadBalancer(this, name, lbProps);\n  }\n\n  private createListener(name: string, lb: NetworkLoadBalancer, port: number): NetworkListener {\n    return lb.addListener(name, {\n      port,\n    });\n  }\n\n  private createDomainName(loadBalancer: NetworkLoadBalancer, name?: string, zone?: IHostedZone) {\n    if (typeof name !== 'undefined') {\n      if (typeof zone === 'undefined') {\n        throw new Error('A Route53 hosted domain zone name is required to configure the specified domain name');\n      }\n\n      new ARecord(this, `DNS${loadBalancer.node.id}`, {\n        zone,\n        recordName: name,\n        target: RecordTarget.fromAlias(new LoadBalancerTarget(loadBalancer)),\n      });\n    }\n  }\n}\n"],
  "mappings": "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",
  "names": []
}
