{
  "version": 3,
  "sources": ["step-scaling-policy.ts"],
  "sourcesContent": ["import { findAlarmThresholds, normalizeIntervals } from '../../aws-autoscaling-common';\nimport * as cloudwatch from '../../aws-cloudwatch';\nimport { Duration } from '../../core';\nimport { Construct } from 'constructs';\nimport { IAutoScalingGroup } from './auto-scaling-group';\nimport { AdjustmentType, MetricAggregationType, StepScalingAction } from './step-scaling-action';\n\nexport interface BasicStepScalingPolicyProps {\n                                    \n  readonly metric: cloudwatch.IMetric;\n\n                                                                                                                     \n  readonly scalingSteps: ScalingInterval[];\n\n                                                                                                                   \n  readonly adjustmentType?: AdjustmentType;\n\n                                                                                                                         \n  readonly cooldown?: Duration;\n\n                                                                                                                                       \n  readonly estimatedInstanceWarmup?: Duration;\n\n                                                                                                                                                                                                                                                                              \n  readonly minAdjustmentMagnitude?: number;\n\n                                                                                                                                                                                                                                           \n  readonly evaluationPeriods?: number;\n\n                                                                                                                                                                                                                                                     \n  readonly metricAggregationType?: MetricAggregationType;\n}\n\nexport interface StepScalingPolicyProps extends BasicStepScalingPolicyProps {\n                                       \n  readonly autoScalingGroup: IAutoScalingGroup;\n}\n\n                                                                                                                                                                                                                                                            \nexport class StepScalingPolicy extends Construct {\n  public readonly lowerAlarm?: cloudwatch.Alarm;\n  public readonly lowerAction?: StepScalingAction;\n  public readonly upperAlarm?: cloudwatch.Alarm;\n  public readonly upperAction?: StepScalingAction;\n\n  constructor(scope: Construct, id: string, props: StepScalingPolicyProps) {\n    super(scope, id);\n\n    if (props.scalingSteps.length < 2) {\n      throw new Error('You must supply at least 2 intervals for autoscaling');\n    }\n\n    const adjustmentType = props.adjustmentType || AdjustmentType.CHANGE_IN_CAPACITY;\n    const changesAreAbsolute = adjustmentType === AdjustmentType.EXACT_CAPACITY;\n\n    const intervals = normalizeIntervals(props.scalingSteps, changesAreAbsolute);\n    const alarms = findAlarmThresholds(intervals);\n\n    if (alarms.lowerAlarmIntervalIndex !== undefined) {\n      const threshold = intervals[alarms.lowerAlarmIntervalIndex].upper;\n\n      this.lowerAction = new StepScalingAction(this, 'LowerPolicy', {\n        adjustmentType: props.adjustmentType,\n        cooldown: props.cooldown,\n        metricAggregationType: props.metricAggregationType ?? aggregationTypeFromMetric(props.metric),\n        minAdjustmentMagnitude: props.minAdjustmentMagnitude,\n        autoScalingGroup: props.autoScalingGroup,\n      });\n\n      for (let i = alarms.lowerAlarmIntervalIndex; i >= 0; i--) {\n        this.lowerAction.addAdjustment({\n          adjustment: intervals[i].change!,\n          lowerBound: i !== 0 ? intervals[i].lower - threshold : undefined, // Extend last interval to -infinity\n          upperBound: intervals[i].upper - threshold,\n        });\n      }\n\n      this.lowerAlarm = new cloudwatch.Alarm(this, 'LowerAlarm', {\n        // Recommended by AutoScaling\n        metric: props.metric,\n        alarmDescription: 'Lower threshold scaling alarm',\n        comparisonOperator: cloudwatch.ComparisonOperator.LESS_THAN_OR_EQUAL_TO_THRESHOLD,\n        evaluationPeriods: props.evaluationPeriods ?? 1,\n        threshold,\n      });\n      this.lowerAlarm.addAlarmAction(new StepScalingAlarmAction(this.lowerAction));\n    }\n\n    if (alarms.upperAlarmIntervalIndex !== undefined) {\n      const threshold = intervals[alarms.upperAlarmIntervalIndex].lower;\n\n      this.upperAction = new StepScalingAction(this, 'UpperPolicy', {\n        adjustmentType: props.adjustmentType,\n        cooldown: props.cooldown,\n        metricAggregationType: props.metricAggregationType ?? aggregationTypeFromMetric(props.metric),\n        minAdjustmentMagnitude: props.minAdjustmentMagnitude,\n        autoScalingGroup: props.autoScalingGroup,\n      });\n\n      for (let i = alarms.upperAlarmIntervalIndex; i < intervals.length; i++) {\n        this.upperAction.addAdjustment({\n          adjustment: intervals[i].change!,\n          lowerBound: intervals[i].lower - threshold,\n          upperBound: i !== intervals.length - 1 ? intervals[i].upper - threshold : undefined, // Extend last interval to +infinity\n        });\n      }\n\n      this.upperAlarm = new cloudwatch.Alarm(this, 'UpperAlarm', {\n        // Recommended by AutoScaling\n        metric: props.metric,\n        alarmDescription: 'Upper threshold scaling alarm',\n        comparisonOperator: cloudwatch.ComparisonOperator.GREATER_THAN_OR_EQUAL_TO_THRESHOLD,\n        evaluationPeriods: props.evaluationPeriods ?? 1,\n        threshold,\n      });\n      this.upperAlarm.addAlarmAction(new StepScalingAlarmAction(this.upperAction));\n    }\n  }\n}\n\nfunction aggregationTypeFromMetric(metric: cloudwatch.IMetric): MetricAggregationType | undefined {\n  const statistic = metric.toMetricConfig().metricStat?.statistic;\n  if (statistic === undefined) { return undefined; } // Math expression, don't know aggregation, leave default\n\n  switch (statistic) {\n    case 'Average':\n      return MetricAggregationType.AVERAGE;\n    case 'Minimum':\n      return MetricAggregationType.MINIMUM;\n    case 'Maximum':\n      return MetricAggregationType.MAXIMUM;\n    default:\n      return MetricAggregationType.AVERAGE;\n  }\n}\n\n                                                                                 \nexport interface ScalingInterval {\n                                                                                                                                                                                                                          \n  readonly lower?: number;\n\n                                                                                                                                                                                                                         \n  readonly upper?: number;\n\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       \n  readonly change: number;\n}\n\n/**\n * Use a StepScalingAction as an Alarm Action\n *\n * This class is here and not in aws-cloudwatch-actions because this library\n * needs to use the class, and otherwise we'd have a circular dependency:\n *\n * aws-autoscaling -> aws-cloudwatch-actions (for using the Action)\n * aws-cloudwatch-actions -> aws-autoscaling (for the definition of IStepScalingAction)\n */\nclass StepScalingAlarmAction implements cloudwatch.IAlarmAction {\n  constructor(private readonly stepScalingAction: StepScalingAction) {\n  }\n\n  public bind(_scope: Construct, _alarm: cloudwatch.IAlarm): cloudwatch.AlarmActionConfig {\n    return { alarmActionArn: this.stepScalingAction.scalingPolicyArn };\n  }\n}\n"],
  "mappings": "wNAAA,yBAAA,QAAA,gCACA,WAAA,QAAA,wBAEA,aAAA,QAAA,cAEA,sBAAA,QAAA,yBAkCA,+BAAuC,cAAA,SAAS,CAM9C,YAAY,MAAkB,GAAY,MAA6B,iBACrE,MAAM,MAAO,IAEb,qFAAI,MAAM,aAAa,OAAS,EAC9B,KAAM,IAAI,OAAM,wDAIlB,KAAM,oBAAqB,AADJ,OAAM,gBAAkB,sBAAA,eAAe,sBAChB,sBAAA,eAAe,eAEvD,UAAY,yBAAA,mBAAmB,MAAM,aAAc,oBACnD,OAAS,yBAAA,oBAAoB,WAEnC,GAAI,OAAO,0BAA4B,OAAW,CAChD,KAAM,WAAY,UAAU,OAAO,yBAAyB,MAE5D,KAAK,YAAc,GAAI,uBAAA,kBAAkB,KAAM,cAAe,CAC5D,eAAgB,MAAM,eACtB,SAAU,MAAM,SAChB,sBAAqB,IAAE,MAAM,yBAAqB,MAAA,KAAA,OAAA,GAAI,0BAA0B,MAAM,QACtF,uBAAwB,MAAM,uBAC9B,iBAAkB,MAAM,mBAG1B,OAAS,GAAI,OAAO,wBAAyB,GAAK,EAAG,IACnD,KAAK,YAAY,cAAc,CAC7B,WAAY,UAAU,GAAG,OACzB,WAAY,IAAM,EAAI,UAAU,GAAG,MAAQ,UAAY,OACvD,WAAY,UAAU,GAAG,MAAQ,YAIrC,KAAK,WAAa,GAAI,YAAW,MAAM,KAAM,aAAc,CAEzD,OAAQ,MAAM,OACd,iBAAkB,gCAClB,mBAAoB,WAAW,mBAAmB,gCAClD,kBAAiB,IAAE,MAAM,qBAAiB,MAAA,KAAA,OAAA,GAAI,EAC9C,YAEF,KAAK,WAAW,eAAe,GAAI,wBAAuB,KAAK,cAGjE,GAAI,OAAO,0BAA4B,OAAW,CAChD,KAAM,WAAY,UAAU,OAAO,yBAAyB,MAE5D,KAAK,YAAc,GAAI,uBAAA,kBAAkB,KAAM,cAAe,CAC5D,eAAgB,MAAM,eACtB,SAAU,MAAM,SAChB,sBAAqB,IAAE,MAAM,yBAAqB,MAAA,KAAA,OAAA,GAAI,0BAA0B,MAAM,QACtF,uBAAwB,MAAM,uBAC9B,iBAAkB,MAAM,mBAG1B,OAAS,GAAI,OAAO,wBAAyB,EAAI,UAAU,OAAQ,IACjE,KAAK,YAAY,cAAc,CAC7B,WAAY,UAAU,GAAG,OACzB,WAAY,UAAU,GAAG,MAAQ,UACjC,WAAY,IAAM,UAAU,OAAS,EAAI,UAAU,GAAG,MAAQ,UAAY,SAI9E,KAAK,WAAa,GAAI,YAAW,MAAM,KAAM,aAAc,CAEzD,OAAQ,MAAM,OACd,iBAAkB,gCAClB,mBAAoB,WAAW,mBAAmB,mCAClD,kBAAiB,IAAE,MAAM,qBAAiB,MAAA,KAAA,OAAA,GAAI,EAC9C,YAEF,KAAK,WAAW,eAAe,GAAI,wBAAuB,KAAK,gBA5ErE,QAAA,kBAAA,oIAiFA,mCAAmC,OAA0B,QAC3D,KAAM,WAAS,IAAG,OAAO,iBAAiB,cAAU,MAAA,KAAA,OAAA,OAAA,GAAE,UACtD,GAAI,YAAc,OAElB,OAAQ,eACD,UACH,MAAO,uBAAA,sBAAsB,YAC1B,UACH,MAAO,uBAAA,sBAAsB,YAC1B,UACH,MAAO,uBAAA,sBAAsB,gBAE7B,MAAO,uBAAA,sBAAsB,SAyBnC,4BAA4B,CAC1B,YAA6B,kBAAoC,CAApC,KAAA,kBAAA,kBAGtB,KAAK,OAAmB,OAAyB,CACtD,MAAO,CAAE,eAAgB,KAAK,kBAAkB",
  "names": []
}
