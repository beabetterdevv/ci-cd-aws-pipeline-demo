{
  "version": 3,
  "sources": ["resource.ts"],
  "sourcesContent": ["import { IResource as IResourceBase, Resource as ResourceConstruct } from '../../core';\nimport { Construct } from 'constructs';\nimport { CfnResource, CfnResourceProps } from './apigateway.generated';\nimport { Cors, CorsOptions } from './cors';\nimport { Integration } from './integration';\nimport { MockIntegration } from './integrations';\nimport { Method, MethodOptions } from './method';\nimport { IRestApi, RestApi } from './restapi';\n\nexport interface IResource extends IResourceBase {\n                                                                                \n  readonly parentResource?: IResource;\n\n                                                                                                                                                                                         \n  readonly restApi: RestApi;\n\n                                                                                                                                                                                                                                                                                                                                                                                                          \n  readonly api: IRestApi;\n\n                                                        \n  readonly resourceId: string;\n\n                                                \n  readonly path: string;\n\n                                                                                                                                    \n  readonly defaultIntegration?: Integration;\n\n                                                                                                                                     \n  readonly defaultMethodOptions?: MethodOptions;\n\n                                                                   \n  readonly defaultCorsPreflightOptions?: CorsOptions;\n\n                                                                                                                                                                                                                                                                                                                 \n  resourceForPath(path: string): Resource;\n\n                                                                                                                                                                                                               \n  addResource(pathPart: string, options?: ResourceOptions): Resource;\n\n                                                                                                                                                                                  \n  getResource(pathPart: string): IResource | undefined;\n\n                                                                                                                                                       \n  addProxy(options?: ProxyResourceOptions): ProxyResource;\n\n                                                                                                                                                                                                                                                                                   \n  addMethod(httpMethod: string, target?: Integration, options?: MethodOptions): Method;\n\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         \n  addCorsPreflight(options: CorsOptions): Method;\n}\n\nexport interface ResourceOptions {\n                                                                                                                                                                                \n  readonly defaultIntegration?: Integration;\n\n                                                                                                                                                                                 \n  readonly defaultMethodOptions?: MethodOptions;\n\n                                                                                                                                                                                                                     \n  readonly defaultCorsPreflightOptions?: CorsOptions;\n}\n\nexport interface ResourceProps extends ResourceOptions {\n                                                                                                                                     \n  readonly parent: IResource;\n\n                                              \n  readonly pathPart: string;\n}\n\nexport abstract class ResourceBase extends ResourceConstruct implements IResource {\n  public abstract readonly parentResource?: IResource;\n                                                                                                                                    \n  public abstract readonly restApi: RestApi;\n  public abstract readonly api: IRestApi;\n  public abstract readonly resourceId: string;\n  public abstract readonly path: string;\n  public abstract readonly defaultIntegration?: Integration;\n  public abstract readonly defaultMethodOptions?: MethodOptions;\n  public abstract readonly defaultCorsPreflightOptions?: CorsOptions;\n\n  private readonly children: { [pathPart: string]: Resource } = { };\n\n  constructor(scope: Construct, id: string) {\n    super(scope, id);\n  }\n\n  public addResource(pathPart: string, options?: ResourceOptions): Resource {\n    return new Resource(this, pathPart, { parent: this, pathPart, ...options });\n  }\n\n  public addMethod(httpMethod: string, integration?: Integration, options?: MethodOptions): Method {\n    return new Method(this, httpMethod, { resource: this, httpMethod, integration, options });\n  }\n\n  public addProxy(options?: ProxyResourceOptions): ProxyResource {\n    return new ProxyResource(this, '{proxy+}', { parent: this, ...options });\n  }\n\n  public addCorsPreflight(options: CorsOptions) {\n    const headers: { [name: string]: string } = { };\n\n    //\n    // Access-Control-Allow-Headers\n\n    const allowHeaders = options.allowHeaders || Cors.DEFAULT_HEADERS;\n    headers['Access-Control-Allow-Headers'] = `'${allowHeaders.join(',')}'`;\n\n    //\n    // Access-Control-Allow-Origin\n\n    if (options.allowOrigins.length === 0) {\n      throw new Error('allowOrigins must contain at least one origin');\n    }\n\n    if (options.allowOrigins.includes('*') && options.allowOrigins.length > 1) {\n      throw new Error(`Invalid \"allowOrigins\" - cannot mix \"*\" with specific origins: ${options.allowOrigins.join(',')}`);\n    }\n\n    // we use the first origin here and if there are more origins in the list, we\n    // will match against them in the response velocity template\n    const initialOrigin = options.allowOrigins[0];\n    headers['Access-Control-Allow-Origin'] = `'${initialOrigin}'`;\n\n    // the \"Vary\" header is required if we allow a specific origin\n    // https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Access-Control-Allow-Origin#CORS_and_caching\n    if (initialOrigin !== '*') {\n      headers.Vary = '\\'Origin\\'';\n    }\n\n    //\n    // Access-Control-Allow-Methods\n\n    let allowMethods = options.allowMethods || Cors.ALL_METHODS;\n\n    if (allowMethods.includes('ANY')) {\n      if (allowMethods.length > 1) {\n        throw new Error(`ANY cannot be used with any other method. Received: ${allowMethods.join(',')}`);\n      }\n\n      allowMethods = Cors.ALL_METHODS;\n    }\n\n    headers['Access-Control-Allow-Methods'] = `'${allowMethods.join(',')}'`;\n\n    //\n    // Access-Control-Allow-Credentials\n\n    if (options.allowCredentials) {\n      headers['Access-Control-Allow-Credentials'] = '\\'true\\'';\n    }\n\n    //\n    // Access-Control-Max-Age\n\n    let maxAgeSeconds;\n\n    if (options.maxAge && options.disableCache) {\n      throw new Error('The options \"maxAge\" and \"disableCache\" are mutually exclusive');\n    }\n\n    if (options.maxAge) {\n      maxAgeSeconds = options.maxAge.toSeconds();\n    }\n\n    if (options.disableCache) {\n      maxAgeSeconds = -1;\n    }\n\n    if (maxAgeSeconds) {\n      headers['Access-Control-Max-Age'] = `'${maxAgeSeconds}'`;\n    }\n\n    //\n    // Access-Control-Expose-Headers\n    //\n\n    if (options.exposeHeaders) {\n      headers['Access-Control-Expose-Headers'] = `'${options.exposeHeaders.join(',')}'`;\n    }\n\n    //\n    // statusCode\n\n    const statusCode = options.statusCode ?? 204;\n\n    //\n    // prepare responseParams\n\n    const integrationResponseParams: { [p: string]: string } = { };\n    const methodResponseParams: { [p: string]: boolean } = { };\n\n    for (const [name, value] of Object.entries(headers)) {\n      const key = `method.response.header.${name}`;\n      integrationResponseParams[key] = value;\n      methodResponseParams[key] = true;\n    }\n\n    return this.addMethod('OPTIONS', new MockIntegration({\n      requestTemplates: { 'application/json': '{ statusCode: 200 }' },\n      integrationResponses: [\n        { statusCode: `${statusCode}`, responseParameters: integrationResponseParams, responseTemplates: renderResponseTemplate() },\n      ],\n    }), {\n      methodResponses: [\n        { statusCode: `${statusCode}`, responseParameters: methodResponseParams },\n      ],\n    });\n\n    // renders the response template to match all possible origins (if we have more than one)\n    function renderResponseTemplate() {\n      const origins = options.allowOrigins.slice(1);\n\n      if (origins.length === 0) {\n        return undefined;\n      }\n\n      const template = new Array<string>();\n\n      template.push('#set($origin = $input.params(\"Origin\"))');\n      template.push('#if($origin == \"\") #set($origin = $input.params(\"origin\")) #end');\n\n      const condition = origins.map(o => `$origin.matches(\"${o}\")`).join(' || ');\n\n      template.push(`#if(${condition})`);\n      template.push('  #set($context.responseOverride.header.Access-Control-Allow-Origin = $origin)');\n      template.push('#end');\n\n      return {\n        'application/json': template.join('\\n'),\n      };\n    }\n  }\n\n  public getResource(pathPart: string): IResource | undefined {\n    return this.children[pathPart];\n  }\n\n  /**\n   * @internal\n   */\n  public _trackChild(pathPart: string, resource: Resource) {\n    this.children[pathPart] = resource;\n  }\n\n  public resourceForPath(path: string): Resource {\n    if (!path) {\n      return this;\n    }\n\n    if (path.startsWith('/')) {\n      if (this.path !== '/') {\n        throw new Error(`Path may start with \"/\" only for the resource, but we are at: ${this.path}`);\n      }\n\n      // trim trailing \"/\"\n      return this.resourceForPath(path.substr(1));\n    }\n\n    const parts = path.split('/');\n    const next = parts.shift();\n    if (!next || next === '') {\n      throw new Error('resourceForPath cannot be called with an empty path');\n    }\n\n    let resource = this.getResource(next);\n    if (!resource) {\n      resource = this.addResource(next);\n    }\n\n    return resource.resourceForPath(parts.join('/'));\n  }\n\n                                                                                                                                                       \n  public get url(): string {\n    return this.restApi.urlForPath(this.path);\n  }\n}\n\n                                                                     \nexport interface ResourceAttributes {\n                                        \n  readonly resourceId: string;\n\n                                                            \n  readonly restApi: IRestApi;\n\n                                                \n  readonly path: string;\n}\n\nexport class Resource extends ResourceBase {\n                                            \n  public static fromResourceAttributes(scope: Construct, id: string, attrs: ResourceAttributes): IResource {\n    class Import extends ResourceBase {\n      public readonly api = attrs.restApi;\n      public readonly resourceId = attrs.resourceId;\n      public readonly path = attrs.path;\n      public readonly defaultIntegration?: Integration = undefined;\n      public readonly defaultMethodOptions?: MethodOptions = undefined;\n      public readonly defaultCorsPreflightOptions?: CorsOptions = undefined;\n\n      public get parentResource(): IResource {\n        throw new Error('parentResource is not configured for imported resource.');\n      }\n\n      public get restApi(): RestApi {\n        throw new Error('restApi is not configured for imported resource.');\n      }\n    }\n\n    return new Import(scope, id);\n  }\n\n  public readonly parentResource?: IResource;\n  public readonly api: IRestApi;\n  public readonly resourceId: string;\n  public readonly path: string;\n\n  public readonly defaultIntegration?: Integration;\n  public readonly defaultMethodOptions?: MethodOptions;\n  public readonly defaultCorsPreflightOptions?: CorsOptions;\n\n  constructor(scope: Construct, id: string, props: ResourceProps) {\n    super(scope, id);\n\n    validateResourcePathPart(props.pathPart);\n\n    this.parentResource = props.parent;\n\n    if (props.parent instanceof ResourceBase) {\n      props.parent._trackChild(props.pathPart, this);\n    }\n\n    const resourceProps: CfnResourceProps = {\n      restApiId: props.parent.api.restApiId,\n      parentId: props.parent.resourceId,\n      pathPart: props.pathPart,\n    };\n    const resource = new CfnResource(this, 'Resource', resourceProps);\n\n    this.resourceId = resource.ref;\n    this.api = props.parent.api;\n\n    // render resource path (special case for root)\n    this.path = props.parent.path;\n    if (!this.path.endsWith('/')) { this.path += '/'; }\n    this.path += props.pathPart;\n\n    const deployment = props.parent.api.latestDeployment;\n    if (deployment) {\n      deployment.node.addDependency(resource);\n      deployment.addToLogicalId({ resource: resourceProps });\n    }\n\n    // setup defaults based on properties and inherit from parent. method defaults\n    // are inherited per property, so children can override piecemeal.\n    this.defaultIntegration = props.defaultIntegration || props.parent.defaultIntegration;\n    this.defaultMethodOptions = {\n      ...props.parent.defaultMethodOptions,\n      ...props.defaultMethodOptions,\n    };\n    this.defaultCorsPreflightOptions = props.defaultCorsPreflightOptions || props.parent.defaultCorsPreflightOptions;\n\n    if (this.defaultCorsPreflightOptions) {\n      this.addCorsPreflight(this.defaultCorsPreflightOptions);\n    }\n  }\n\n                                                                                                                                                                                  \n  public get restApi(): RestApi {\n    if (!this.parentResource) {\n      throw new Error('parentResource was unexpectedly not defined');\n    }\n    return this.parentResource.restApi;\n  }\n}\n\nexport interface ProxyResourceOptions extends ResourceOptions {\n                                                                                                                                                                                    \n  readonly anyMethod?: boolean;\n}\n\nexport interface ProxyResourceProps extends ProxyResourceOptions {\n                                                                                                                                     \n  readonly parent: IResource;\n}\n\n                                                                                                                                                                                     \nexport class ProxyResource extends Resource {\n                                                                                                                                         \n  public readonly anyMethod?: Method;\n\n  constructor(scope: Construct, id: string, props: ProxyResourceProps) {\n    super(scope, id, {\n      parent: props.parent,\n      pathPart: '{proxy+}',\n      defaultIntegration: props.defaultIntegration,\n      defaultMethodOptions: props.defaultMethodOptions,\n    });\n\n    const anyMethod = props.anyMethod ?? true;\n    if (anyMethod) {\n      this.anyMethod = this.addMethod('ANY');\n    }\n  }\n\n  public addMethod(httpMethod: string, integration?: Integration, options?: MethodOptions): Method {\n    // In case this proxy is mounted under the root, also add this method to\n    // the root so that empty paths are proxied as well.\n    if (this.parentResource && this.parentResource.path === '/') {\n      // skip if the root resource already has this method defined\n      if (!(this.parentResource.node.tryFindChild(httpMethod) instanceof Method)) {\n        this.parentResource.addMethod(httpMethod, integration, options);\n      }\n    }\n    return super.addMethod(httpMethod, integration, options);\n  }\n}\n\nfunction validateResourcePathPart(part: string) {\n  // strip {} which indicate this is a parameter\n  if (part.startsWith('{') && part.endsWith('}')) {\n    part = part.substr(1, part.length - 2);\n\n    // proxy resources are allowed to end with a '+'\n    if (part.endsWith('+')) {\n      part = part.substr(0, part.length - 1);\n    }\n  }\n\n  if (!/^[a-zA-Z0-9\\.\\_\\-]+$/.test(part)) {\n    throw new Error(`Resource's path part only allow [a-zA-Z0-9._-], an optional trailing '+'\n      and curly braces at the beginning and the end: ${part}`);\n  }\n}\n"],
  "mappings": "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",
  "names": []
}
