{
  "version": 3,
  "sources": ["require-imdsv2-aspect.ts"],
  "sourcesContent": ["import * as cdk from '../../../core';\nimport { IConstruct } from 'constructs';\nimport { CfnLaunchTemplate } from '../ec2.generated';\nimport { Instance } from '../instance';\nimport { LaunchTemplate } from '../launch-template';\n\n/**\n * Properties for `RequireImdsv2Aspect`.\n */\ninterface RequireImdsv2AspectProps {\n                                                                                                                     \n  readonly suppressWarnings?: boolean;\n}\n\n/**\n * Base class for Aspect that makes IMDSv2 required.\n */\nabstract class RequireImdsv2Aspect implements cdk.IAspect {\n  protected readonly suppressWarnings: boolean;\n\n  constructor(props?: RequireImdsv2AspectProps) {\n    this.suppressWarnings = props?.suppressWarnings ?? false;\n  }\n\n  abstract visit(node: IConstruct): void;\n\n                                                                                                                                                                                        \n  protected warn(node: IConstruct, message: string) {\n    if (this.suppressWarnings !== true) {\n      cdk.Annotations.of(node).addWarning(`${RequireImdsv2Aspect.name} failed on node ${node.node.id}: ${message}`);\n    }\n  }\n}\n\n                                                        \nexport interface InstanceRequireImdsv2AspectProps extends RequireImdsv2AspectProps {\n                                                                                                                                                                                                                                                                                                                                                                                                                 \n  readonly suppressLaunchTemplateWarning?: boolean;\n}\n\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                \nexport class InstanceRequireImdsv2Aspect extends RequireImdsv2Aspect {\n  private readonly suppressLaunchTemplateWarning: boolean;\n\n  constructor(props?: InstanceRequireImdsv2AspectProps) {\n    super(props);\n    this.suppressLaunchTemplateWarning = props?.suppressLaunchTemplateWarning ?? false;\n  }\n\n  visit(node: IConstruct): void {\n    if (!(node instanceof Instance)) {\n      return;\n    }\n    if (node.instance.launchTemplate !== undefined) {\n      this.warn(node, 'Cannot toggle IMDSv1 because this Instance is associated with an existing Launch Template.');\n      return;\n    }\n\n    const name = `${node.node.id}LaunchTemplate`;\n    const launchTemplate = new CfnLaunchTemplate(node, 'LaunchTemplate', {\n      launchTemplateData: {\n        metadataOptions: {\n          httpTokens: 'required',\n        },\n      },\n      launchTemplateName: name,\n    });\n    node.instance.launchTemplate = {\n      launchTemplateName: name,\n      version: launchTemplate.getAtt('LatestVersionNumber').toString(),\n    };\n  }\n\n  protected warn(node: IConstruct, message: string) {\n    if (this.suppressLaunchTemplateWarning !== true) {\n      super.warn(node, message);\n    }\n  }\n}\n\n                                                              \nexport interface LaunchTemplateRequireImdsv2AspectProps extends RequireImdsv2AspectProps {}\n\n                                                                                                                                                                                                                                        \nexport class LaunchTemplateRequireImdsv2Aspect extends RequireImdsv2Aspect {\n  constructor(props?: LaunchTemplateRequireImdsv2AspectProps) {\n    super(props);\n  }\n\n  visit(node: IConstruct): void {\n    if (!(node instanceof LaunchTemplate)) {\n      return;\n    }\n\n    const launchTemplate = node.node.tryFindChild('Resource') as CfnLaunchTemplate;\n    const data = launchTemplate.launchTemplateData;\n    if (cdk.isResolvableObject(data)) {\n      this.warn(node, 'LaunchTemplateData is a CDK token.');\n      return;\n    }\n\n    const metadataOptions = (data as CfnLaunchTemplate.LaunchTemplateDataProperty).metadataOptions;\n    if (cdk.isResolvableObject(metadataOptions)) {\n      this.warn(node, 'LaunchTemplateData.MetadataOptions is a CDK token.');\n      return;\n    }\n\n    const newData: CfnLaunchTemplate.LaunchTemplateDataProperty = {\n      ...data,\n      metadataOptions: {\n        ...metadataOptions,\n        httpTokens: 'required',\n      },\n    };\n    launchTemplate.launchTemplateData = newData;\n  }\n}\n"],
  "mappings": "kRAAA,IAAA,QAAA,iBAEA,gBAAA,QAAA,oBACA,WAAA,QAAA,eACA,kBAAA,QAAA,sBAaA,yBAAkC,CAGhC,YAAY,MAAgC,QAC1C,KAAK,iBAAgB,IAAG,OAAK,KAAA,OAAL,MAAO,oBAAgB,MAAA,KAAA,OAAA,GAAI,GAM3C,KAAK,KAAkB,QAAe,CAC9C,AAAI,KAAK,mBAAqB,IAC5B,IAAI,YAAY,GAAG,MAAM,WAAW,GAAG,oBAAoB,uBAAuB,KAAK,KAAK,OAAO,YAYzG,yCAAiD,oBAAmB,CAGlE,YAAY,MAAwC,QAClD,MAAM,2FACN,KAAK,8BAA6B,IAAG,OAAK,KAAA,OAAL,MAAO,iCAA6B,MAAA,KAAA,OAAA,GAAI,GAG/E,MAAM,KAAgB,CACpB,GAAI,CAAE,gBAAgB,YAAA,UACpB,OAEF,GAAI,KAAK,SAAS,iBAAmB,OAAW,CAC9C,KAAK,KAAK,KAAM,8FAChB,OAGF,KAAM,MAAO,GAAG,KAAK,KAAK,mBACpB,eAAiB,GAAI,iBAAA,kBAAkB,KAAM,iBAAkB,CACnE,mBAAoB,CAClB,gBAAiB,CACf,WAAY,aAGhB,mBAAoB,OAEtB,KAAK,SAAS,eAAiB,CAC7B,mBAAoB,KACpB,QAAS,eAAe,OAAO,uBAAuB,YAIhD,KAAK,KAAkB,QAAe,CAC9C,AAAI,KAAK,gCAAkC,IACzC,MAAM,KAAK,KAAM,UAlCvB,QAAA,4BAAA,0JA2CA,+CAAuD,oBAAmB,CACxE,YAAY,MAA8C,CACxD,MAAM,iGAGR,MAAM,KAAgB,CACpB,GAAI,CAAE,gBAAgB,mBAAA,gBACpB,OAGF,KAAM,gBAAiB,KAAK,KAAK,aAAa,YACxC,KAAO,eAAe,mBAC5B,GAAI,IAAI,mBAAmB,MAAO,CAChC,KAAK,KAAK,KAAM,sCAChB,OAGF,KAAM,iBAAmB,KAAsD,gBAC/E,GAAI,IAAI,mBAAmB,iBAAkB,CAC3C,KAAK,KAAK,KAAM,sDAChB,OAGF,KAAM,SAAwD,IACzD,KACH,gBAAiB,IACZ,gBACH,WAAY,aAGhB,eAAe,mBAAqB,SA9BxC,QAAA,kCAAA",
  "names": []
}
